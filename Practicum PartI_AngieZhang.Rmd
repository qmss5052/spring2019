---
title: "PART I. Identifying BC & pregnancy"
author: "Angie Zhang (incorporated Erin's data exploration)"
date: "March 5th 2019"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Step #1. Filter patients by gender 
```{r}
# Load in 'patients' data
patients<-read.csv(file.choose()) 
```

```{r}
library(dplyr)
library(tidyr)

# Identify female patients
female <- patients %>%
  filter(GENDER=="F")

count(female) 
head(female)
```
There are a total of 721 female patients from our observatons


Step #2. Identify BCs vs.non-BC - confirm on gender

The codes assigned to birth control are as follows (sorted by type of bc): 
(1) Injections:
  * 1000158 = 0.65 ML depo-subQ provera 160 MG/ML Prefilled Syringe
  * 1000128 = 1 ML Depo-Provera 150 MG/ML Injection
(2) Pills:
  * 748962 = Camila 28 Day Pack
  * 831533 = Errin 28 Day Pack
  * 749785 = Ortho Tri-Cyclen 28 Day Pack
  * 749762 = Seasonique 91 Day Pack
  * 751905 = Trinessa 28 Day Pack
  * 748856 = Yaz 28 Day Pack* 1359133 = Estrostep Fe 28 Day Pack
  * 757594 = Jolivette 28 Day Pack
  * 748879 = Levora 0.15/30 28 Day Pack
  * 235389 = Mestranol / Norethynodrel [Enovid]
(3) IUD/implants:
  * 1605257 = Liletta 52 MG Intrauterine System
  * 1856546 = Kyleena 19.5 MG Intrauterine System
  * 807283 = Mirena 52 MG Intrauterine System
  * 1111011 = Nexplanon 68 MG Drug Implant
  * 646250 = Implanon 68 MG Drug Implant
(4) Viginal Ring:
  * 1367439 = NuvaRing 0.12/0.015 MG per 24HR 21 Day Vaginal Ring

```{r}
# Load in 'medications' data
meds<-read.csv(file.choose()) 
```

```{r, eval=TRUE, echo=FALSE}
# label birth control using codes identified above
bc <- c(1000158, 1000128, 748962, 831533, 1359133, 646250, 757594, 1856546, 748879, 1605257, 235389, 807283, 1111011, 1367439, 749785, 749762, 751905, 748856)
head(meds)

# create a dataframe for those on bc
meds_bc<- meds %>% filter(CODE %in% bc)

# Find out the numer of patients who are/were on bc
meds %>% filter(CODE %in% bc) %>% summarise(n_distinct(PATIENT))

# check to ensure all those who use BC are actually females 
meds_bc$PATIENT[!(meds_bc$PATIENT %in% female$ID)]

```
There are 246 unique patients who took birth control, whom are all confirmed to be females. 


Step #3. Create indicator variable for birth control: 1 if on BC, 0 if not.

```{r}
meds_bc$bc_yes <- rep(1, nrow(meds_bc))
patient_bc <- merge(x=female, y=meds_bc[,c("PATIENT","bc_yes")], by.x="ID", by.y="PATIENT", all.x = TRUE)

patient_bc$bc_yes <- transform(patient_bc, bc_yes=as.numeric(bc_yes))

patient_bc$bc_yes <- ifelse(patient_bc$bc_yes==1,1,0)

names(patient_bc)
```


Step #4, Examine characteristics of BC paitents.
   (1) Overall: characterstics of those who use BC (by race, age, marital status)
   (2) By category: pills, IUD, Viginal ring, Inplant, injection,

```{r}
# add race and marital status columns on meds_bc file, showing the demographic info of those on bc
med_demo <- merge(x=meds_bc, y=patients[,c("ID","RACE","MARITAL")], by.x="PATIENT", by.y="ID", all.x = TRUE)
head(med_demo)
med_race<- med_demo%>%
  group_by(RACE)%>%
  tally
med_race
barplot(med_race$n,main = "Race Distribution for bc users",
xlab = "Race",
ylab = "# of Patients",
names.arg = c("asian","black","hispanic","white"))
```

```{r}
#marital status

med_marital<- med_demo%>%
  group_by(MARITAL)%>%
  tally
med_marital
barplot(med_marital$n, main="Distribution of marital status for bc users", xlab ="marital status", ylab="# of patients", names.arg=c("N/A","Married","Single"))


```

```{r}
# Calculate patients age
# install.packages('eeptools')
library(eeptools)
library(lubridate)

patients$BIRTHDATE<-ymd(patients$BIRTHDATE, format="%m/%d/%Y")
patients$DEATHDATE<-ymd(patients$DEATHDATE, format="%m/%d/%Y")
str(patients$BIRTHDATE)
patients%>% 
  mutate(age= as.period(interval(patients$BIRTHDATE, patients$DEATHDATE), unit = "year"))
  as.numeric(age)
head(age)

#mutate( age = age_calc(patients$BIRTHDATE, enddate = Sys.Date(), units='years', precise = FALSE)
#patients$age <- age_calc(dob=patients$BIRTHDATE, enddate = patients$DEATHDATE, units='years', precise = FALSE)
```

  
  
Step #5. Identify Pregnant vs.non-Pregnant (using Careplan, Conditions and Encounter Dataset )

### Careplan
```{r}
# load Careplan file
care<-read.csv(file.choose()) 
```

```{r, eval=TRUE, echo=FALSE}
# Looking at normal pregnancies within Careplans dataset.
library(dplyr)
normpreg <- care %>%
  filter(REASONDESCRIPTION=="Normal pregnancy")
normpreg %>% summarize(n_distinct(PATIENT))
```
In the Careplans csv, there are 167 pregnancies. The condition descriptions for patients without any "ReasonDescription," by and large, do not appear to reflect pregnancies. 

### Conditions
```{r}
# Load in conditions data
cond<-read.csv(file.choose()) 
```

An initial review of conditions data revealed there are 10 descriptions that could relate to pregenancy.
```{r, eval=TRUE, echo=FALSE}
obs <- c("Antepartum eclampsia", "Blighted ovum", "Complication occuring during pregnancy", "Congenital uterine anomaly", "Fetus with chromosomal abnormality", "Miscarriage in first trimester", "Miscarriage in second trimester", "Normal pregnancy", "Preeclampsia", "Tubal pregnancy")
allpreg <- cond %>%
  filter(DESCRIPTION %in% obs)
allpreg %>% summarize(n_distinct(PATIENT))
```
In the Conditions csv, there are 139 unique patients with pregnancy-related descriptions. 

### Encounters
```{r}
# Load in encounters data
encount<-read.csv(file.choose()) 
```

In the Encounters csv, three Descriptions seem specific to pregnancies, "Obstretric emergency hospital admission," "Prenatal initial visit," and "Prenatal visit." When applying the same pregnancy-related categories used for the Conditions csv to the ReasonDescription column, "Admission to surgical department" and "Patient-initiated encounter" were highlighted, indicating that the three categories I initially identified do not comprehensively select all pregnancy-related encounters. The following code tries to account for that. 

```{r, eval=TRUE, echo=FALSE}
obs2 <- c("Obstretric emergency hospital admission", "Prenatal initial visit", "Prenatal visit")
pregencount <- encount %>%
  filter(DESCRIPTION %in% obs2 | REASONDESCRIPTION %in% obs)
pregencount %>% summarise(n_distinct(PATIENT))
```
Per the Encounters csv, there are 135 patients who attended pregnancy-related doctor's appointments (which is taken as a proxy for pregnancy).

## Merging datasets
combine the three datasets from above to find out the number of unique pregnancies.
```{r, eval=TRUE, echo=FALSE}
half <- merge(x=pregencount, y=normpreg, by="PATIENT", all = TRUE) #combine encounter with careplan data

colnames(half)[2]<-"enc.ID"
colnames(half)[3]<-"enc.DATE"
colnames(half)[4]<-"enc.CODE"
colnames(half)[5] <- "enc.DESCRIPTION"
colnames(half)[6] <-"enc.REASONCODE"
colnames(half)[7] <-"enc.REASONDESCRIPTION"
colnames(half)[8] <-"cp.ID"
colnames(half)[9] <-"cp.START"
colnames(half)[10] <-"cp.STOP"
colnames(half)[11] <-"cp.ENCOUNTER"
colnames(half)[12] <-"cp.CODE"
colnames(half)[13] <-"cp.DESCRIPTION"
colnames(half)[14]<-"cp.REASONCODE"
colnames(half)[15] <-"cp.REASONDESCRIPTION"

names(half)

all <- merge(x=half, y=allpreg, by="PATIENT", all = TRUE) #combine with conditions data

colnames(all)[16]<-"cond.START"
colnames(all)[17]<-"cond.STOP"
colnames(all)[18]<-"cond.ENCOUNTER"
colnames(all)[19]<-"cond.CODE"
colnames(all)[20]<-"cond.DESCRIPTION"
names(all)
all %>% summarize(n_distinct(PATIENT))
```
There are 191 unique pregnancies amongst the three spreadsheets. 


Step #6. BC to Pregnant
```{r, eval=TRUE, echo=FALSE}
meds_bc <- meds %>%
  filter(CODE %in% bc)
names(meds_bc)[names(meds_bc) == "CODE"] <- "CODE.bc"
names(meds_bc)[names(meds_bc) == "DESCRIPTION"] <- "DESCRIPTION.bc"
both <- merge(x=meds_bc, y=all, by="PATIENT")
both %>% summarize(n_distinct(PATIENT))
```
141 women who are on birth control got pregnant (or at least had a pre-pregnancy consultation).


Step #7. Check for multiple instances of pregnancy 
```{r}
library(psych)
names(all)
all$cp.START <- as.Date.POSIXct(all$cp.START, tryFormats = "%m/%d/%Y")
all$cp.STOP <- as.Date.POSIXct(all$cp.STOP, tryFormats = "%m/%d/%Y")
all$cond.START <- as.Date.POSIXct(all$cond.START, tryFormats = "%m/%d/%Y")
all$cond.STOP <- as.Date.POSIXct(all$cond.STOP, tryFormats = "%m/%d/%Y")
str(all)

all%>%
  group_by(PATIENT) %>%
  with(., difftime(max(cp.START), min(cp.STOP)))



all$df_cp <- all$cp.STOP - all$cp.START
all$df_cond <- all$cond.STOP - all$cond.START

describe(all$df_cp)

all%>%
  group_by(PATIENT) %>%
  summarize(cp_days=sum(df_cp),cond_days=sum(df_cond))

head(all$df_cp)
head(all$df_cond)

```

Min and max dates that indicate that (>9months)

##Step 8. Create dataframe inclusive of pregnancy and birth control durations

### 8.1 Combine pregnancy data with encounters.

```{r}
#Create an encounters data.frame for female patients with binary variables indicating bc and pregnancy. Date variable now reads as a date with lubridate ymd() call.
encount_fem <- encount %>%
  filter(PATIENT %in% female$ID) %>%
  mutate(bc.yes = ifelse(PATIENT %in% meds_bc$PATIENT, 1,0), pg.yes = ifelse(PATIENT %in% all$PATIENT, 1,0), DATE = ymd(DATE)) %>%
  group_by(PATIENT) %>%
  mutate(en.first = min(DATE), en.last = max(DATE)) %>% 
  ungroup() %>%
  group_by(PATIENT, REASONCODE) %>%
  mutate(pg.start = case_when(DESCRIPTION %in% obs2 | REASONDESCRIPTION %in% obs ~ min(DATE)), pg.stop = case_when(DESCRIPTION %in% obs2 | REASONDESCRIPTION %in% obs ~ max(DATE))) %>%
  mutate(pg.length = pg.stop - pg.start)

length(unique(encount_fem$PATIENT)) #720 - When comparing with above, notice that 1 female patient never came in for an encounter.

#Check to make sure all patients ever on birth control are present.
length(unique(encount_fem$PATIENT[encount_fem$bc.yes==1])) #246 unique bc users, which matches above. 

##Issue - I tried to write a statement setting the length above and the filtered statement checking the number of patients on bc (see line 71) equalivant so the output would print TRUE if correct (essentially to automate checking my work), but it didn't work. Thoughts on how to structure that?

#Check to make sure all patients ever pregnant are present.
length(unique(encount_fem$PATIENT[encount_fem$pg.yes==1])) #191 unique pregnancies, which matches above.

#Check if there are any women who were pregnant twice...
double_pg1 <- encount_fem %>% mutate(pg.length = as.numeric(pg.length)) %>%
  filter(pg.length > 252)
n_distinct(double_pg1$PATIENT) #74 patients had pregnancy-related visits longer than 9 months.

#Given that prenatal care + pregnancy lasts longer than 9 months, let's look at any pregnancy-related visits that could have lasted longer than a year.
double_pg2 <- encount_fem %>% mutate(pg.length = as.numeric(pg.length)) %>%
  filter(pg.length > 365)
n_distinct(double_pg2$PATIENT) #73 women probably had more than on pregnancy. 
double_pg2

##Issue - how to recode to separate out each pregnancy? 
```

How to address (recode) 73 patients with multiple pregnancies to be discussed. 

### 8.2 Combine encount_fem data.frame with birth control data.

Also creating bc categorical variable, bc_type. Note bc category types vary slightly from those suggested by Angie! (Pill is separated into two groups.)

```{r}
colnames(encount_fem)[1] <- "en.id"
colnames(encount_fem)[2] <- "en.date"
colnames(encount_fem)[4] <- "en.code"
colnames(encount_fem)[5] <- "en.descr"
colnames(encount_fem)[6] <- "en.reasoncode"
colnames(encount_fem)[7] <- "en.reasondescr"

names(meds_bc)
durations <- merge(x=encount_fem, y=meds_bc[, c("PATIENT", "START", "STOP", "ENCOUNTER", "CODE.bc", "DESCRIPTION.bc")], by="PATIENT", all.x=TRUE)

names(durations)

colnames(durations)[15] <- "bc.start"
colnames(durations)[16] <- "bc.stop"
colnames(durations)[17] <- "meds.encount"
colnames(durations)[18] <- "bc.code"
colnames(durations)[19] <- "bc.descrip"

tbl_df(durations)

#Add categorical variable for bc type, change variable type of bc.start and bc.stop to dates, and create bc.length. 
durations <- durations %>% 
  mutate(bc.type = case_when(bc.code==1000158 | bc.code==1000128 ~ "injection",
                             bc.code==1856546 | bc.code==1605257 | bc.code==807283 ~ "IUD", 
                             bc.code==646250 | bc.code==1111011 ~ "implant", 
                             bc.code==1367439 ~ "ring", 
                             bc.code==748962 | bc.code==831533 | bc.code==1359133 | bc.code==757594 | bc.code==748879 | bc.code==235389 | bc.code==749785 | bc.code==751905 | bc.code==748856 ~ "pill28", 
                             bc.code==749762 ~ "pill91"))
durations <- durations %>% mutate(bc.start = mdy(bc.start), bc.stop = mdy(bc.stop))

durations <- durations %>% mutate(bc.length = bc.stop - bc.start)
durations$bc.length <- as.numeric(durations$bc.length)

#Issue - is there a more elegant way to mutate all of the above in one? I tried adding those new variable calls to the original line of code, but unless they were separated out, all dates failed to parse.

#Double checking my new bc.length variable. 
summary(durations$bc.length) 

#A duration of -36159 doesn't seem right and 8364 NAs to be reviewed (note some of those are women who were never on bc).

durations %>%
  count(bc.length < 0) #confirmation that there is only one patient with a negative bc length. 

#In exploring that patient further, her bc.start date is 2068-01-06.
```

```{r}
#Reviewing patients to identify those whose bc start dates are impossible. 
durations %>% filter(bc.yes==1) %>%
  group_by(PATIENT, bc.type) %>%
  arrange(desc(bc.start))
```

The following four patients have unrealistic birth control start dates. Rather than removing them from the dataset, all four are now recoded as not being on birth control.

* Number a8b24df6-d727-45d2-b269-cf482c17a402 
  + encounter ID number 2d536593-07c9-4ec1-b2af-1dc97848718a. 
  + Her bc start date is 2068-01-06 and end date is 1969-01-06. 
  + Her only encounter date in the whole dataset is 1974-04-28.
  
* Number f88d0d0e-614b-4ab2-aae4-12d103778e0a
  + encounter ID number b6d96fcf-2c8c-49f8-8ae9-f60ee08e89d6. 
  + Her bc start date is 2064-12-10 and end date is NA. 
  + Her only encounter date was 1965-04-05.

* Number 492624fb-49dc-4e16-b6b9-b41619934cd4
  + encounter ID number ed48dc44-8afd-491d-aea6-bb0566f6dd3c
  + Her bc start date is 2064-12-11.
  + Her only encounter date was 1982-01-18.

* Number cf9a3357-e145-480e-a2b9-7f9c595b9783
  + encounter ID number 6d371dd4-044e-4201-82da-f82555f471da
  + Her bc start date is 2060-10-29.
  + Her only encounter date was 1961-01-23.

Issue - This means these patients should also be recoded as not on birth control in Angie's data.frames. 

```{r}
tail(durations %>% filter(bc.yes==1) %>%
  group_by(PATIENT, bc.type) %>%
  arrange(desc(bc.start)))

#Changing the four patients whose bc start dates don't make sense to not on birth control by adjusting the bc.yes, bc.start, and bc.stop variables. That should reduce the number of patients who ever used birth control to 242.

notonbc <- c("a8b24df6-d727-45d2-b269-cf482c17a402", "f88d0d0e-614b-4ab2-aae4-12d103778e0a", "492624fb-49dc-4e16-b6b9-b41619934cd4", "cf9a3357-e145-480e-a2b9-7f9c595b9783")

durationsFV <- durations %>%
  mutate(bc.yes = ifelse(PATIENT %in% notonbc, 0, bc.yes), bc.start = as.Date(ifelse(PATIENT %in% notonbc, NA, as.character(bc.start))), bc.stop = as.Date(ifelse(PATIENT %in% notonbc, NA, as.character(bc.stop))))

#Checking recodes...
table(durations$bc.yes)
table(durationsFV$bc.yes) #ISSUE: 5 patients were recoded to not being pregnant instead of four...

length(unique(durationsFV$PATIENT[durationsFV$bc.yes==1])) #However the number of patients on  birth control, 242, is correct. 

durationsFV %>% filter(bc.yes==1) %>%
  group_by(PATIENT, bc.type) %>%
  arrange(bc.start)
```

Notice there are a lot (223) of women whose birth control prescription date (bc.start) proceeds their first encounter date. This should not be an issue for the EHA. 

```{r}
#How many women have a bc prescription date that proceeds their first encounter date? 

durationsFV %>% 
  filter(bc.yes==1, bc.start > en.first) %>%
  group_by(PATIENT) %>%
  summarize(n_distinct(PATIENT)) %>%
  tally(n()) #223
```

```{r}
#What about those bc.length NA patients? 
durationsFV %>% filter(bc.yes==1) %>%
  group_by(PATIENT, bc.type) %>%
  filter(is.na(bc.length))

durationsFV %>% filter(bc.yes==1) %>%
  group_by(PATIENT, bc.type) %>%
  filter(is.na(bc.length)) %>%
  group_by(PATIENT) %>%
  summarize(n_distinct(PATIENT)) %>%
  tally(n()) #95 women

#Are these all women who have not stopped their birth control? Yes, see below. Note these may be cases of censoring.

durationsFV %>% filter(bc.yes==1) %>%
  group_by(PATIENT, bc.type) %>%
  filter(is.na(bc.stop)) %>%
  group_by(PATIENT) %>%
  summarize(n_distinct(PATIENT)) %>%
  tally(n()) #Also 95 women. 

#Could some of these women have just left the hopsital? If last encounter date is a year prior to 2017-10-27, then the type of birth control needs to be checked and it could be possible... 

durationsFV %>% filter(bc.yes==1) %>%
  group_by(PATIENT, bc.type) %>%
  filter(is.na(bc.length), bc.start < "2016-10-27") %>%
  group_by(PATIENT) %>% 
  summarize(n_distinct(PATIENT)) %>%
  tally(n()) #There are 13 women like this. 

durationsFV %>% filter(bc.yes==1) %>%
  select(-en.id, -en.code, -en.date, -en.descr, -en.reasoncode, -en.reasondescr, -meds.encount) %>% #cleaning up dataframe to only look at patients of interest
  group_by(PATIENT, bc.type) %>%
  filter(is.na(bc.length), bc.start < "2016-10-27") %>%
  distinct()
```

### What to do with the following 13 patients? 

Birth control prescription length (see doc on Piazza) to be confirmed in order to address the following. 

* Patient number 0632f144-2ea4-43e3-b115-a535a4d6f323
  + Started bc (ring) on 2005-12-18.
  + Had only one encounter date, 2006-01-25.
  + Censored observation?

* Patient number 16077486-5747-4abe-8321-ba290fb7197c
  + Started bc (pill28) on 1998-01-14.
  + Had only one encounter date, 1998-08-21.
  + Censored observation?

* Patient number 353c5ff1-6970-4dba-ae96-1f69fb02f23e
  + Started bc (injection) on 2013-07-31.
  + Last encounter date was 2013-11-05.
  + Censored observation? 

* Patient number 6059a250-fc18-4b64-bf6d-967848ae252e
  + Started bc (pill28) on 2007-09-19	
  + Last encounter was 2008-07-25. 
  + Censored observation? 

* Patient number 72f7b009-e5e2-430d-ab43-74c1271a4dd5
  + Started bc (pill28) on 2004-08-22
  + Had only one encounter date, 2005-04-24.
  + Censored observation? 

* Patient number 7c204f7d-dccd-4e4a-9c45-9c6f4d40a516
  + Started bc (IUD) on 2004-09-21.
  + Had only one encounter date 2005-04-19.
  + Censored observation? 

* Patient number 85a0e9a4-afd3-47db-8007-7ba43a8fbddc
  + Started bc (implant) on 2015-10-12.
  + Last encounter date was 2016-06-04.
  + Censored observation? 

* Patient number 8a4c76ce-1710-4632-ac34-7eaedcba5595
  + Started bc (implant) on 2009-04-13.
  + Last encounter date was 2010-01-11.
  + Censored observation? 

* Patient number a00d4729-aab3-4308-9c95-6012926d6ea3
  + Started bc (pill28) 2004-08-29.
  + Had only one encounter date, 2005-04-24.
  + Censored observation? 

* Patient number b5ff95c6-b88a-478e-8416-671f0883c054
  + Started bc (pill28) on 2001-06-07.
  + Had only on encounter date, 2001-06-20.
  + Censored observation? 

* Patient number d0723d88-4368-4f06-9dca-51815e6fc767
  + Started bc (IUD) on 2006-04-25.
  + Had only one encounter date, 2006-06-09.
  + Censored observation?

* Patient number d538bb58-f5ce-4609-83cf-bfc495616eda
  + Started bc (pill28) on 2001-02-22.
  + Had only one encounter date, 2001-06-01.
  + Censored observation? 

* Patient number d53eb441-cb33-48d4-ba97-252eca3b41ff
  + Started bc (pill28) on 2007-12-03.
  + Last encounter date was 2008-03-18.
  + Censored observation? 

How many users of each type of birth control do we have? 

```{r}
#How many users of each type of birth control do we have?
library(compareGroups)

num_bc_type <- durationsFV %>% group_by(PATIENT, bc.type) %>%
  filter(bc.yes==1) %>%
  count(PATIENT, bc.type) %>% #Issue - is there a way to do this without "count()"?
  select(bc.type)
descrTable(num_bc_type) #Notice higher N than bc users, some are using more than one type at different time points.
```

How long, on average, did patients spend on each birth control type? What was the standard deviation of birth control use, per type? 

```{r}
sumstats <- durationsFV %>% select(-en.id) %>% #removing encounter-specific data
  filter(bc.yes==1, !is.na(bc.length)) %>% #only bc users who we observed stopping bc
  distinct() %>% #only unique observations
  group_by(bc.type) %>%
  mutate(avg.bc.length = mean(bc.length), sd.bc.length = sd(bc.length))
tbl_df(sumstats)
```
